<metal:main use-macro="load: ../master.pt">

    <metal:content fill-slot="title">Violence and criminality analysis</metal:content>

    <metal:content fill-slot="breadcrumbs">
        <li class="active">Crime Analysis</li>
    </metal:content>

    <metal:content fill-slot="content">

        <div class="row" id="analysis">

            <div class="col-md-2">
                <!-- Categories on the left -->
                <div class="row" id="taxonomy">
                    <!-- Terms grouped by taxonomy -->
                    <div id="load-tax" class="loading"></div>

                </div>

            </div>

            <div class="col-md-8">
                <div class="row">
                    <!-- Map with status on the country -->
                    <div id="load-maps" class="loading"></div>
                    <div id="map_canvas" style="height: 500px; width: 100%;"></div>
                </div>

                <div class="row">
                    <!-- Document list -->
                    <table class="table-bordered" id="status-table" style="display: none;">
                        <thead>
                            <tr>
                                <th style="width: 10%;">Date</th>
                                <th style="width: 5%;">+/-</th>
                                <th style="width: 75%;">Status</th>
                                <th style="width: 10%;">Origin</th>
                            </tr>
                        </thead>
                        <tbody id="status">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="col-md-2">
                <div class="row">
                    <!-- Terms frequency matrix -->
                    <ul class="list-group">
                      <li class="list-group-item" tal:repeat="elm terms['results']">
                        <span class="badge">${elm['frequency']}</span>
                        ${elm['token']}
                      </li>
                    </ul>
                </div>

                <div class="row">
                    <!-- Tag clouds -->
                </div>
            </div>


        </div>

    </metal:content>

    <metal:content fill-slot="javascript">

        <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=${key}&sensor=true&region=BR"></script>
        <script src="${request.static_url('lbsociamgame:static/js/lib/maps.js')}"></script>
        <script src="${request.static_url('lbsociamgame:static/js/lib/analysis.js')}"></script>

        <script type="text/javascript">

            $(function() {

                $(document).ready(function(){

                    $.ajax({
                        type: "GET",
                        url: "${request.route_url('crime_topics')}",
                        data: "",
                        dataType: "json",
                        success: function(topics){
                            $( '#load-tax' ).hide();
                            //var topics = data;
                            // Asynchronously load the template.
                            var html = '<ul class="list-group">';
                            for (var i in topics ) {
                                //alert(topics[i]);
                                html += '<li class="list-group-item"><h4>Topic #'+i+'</h4>';
                                html += '<ul class="list-group">';
                                for (var j = 0; j < topics[i].length ; j++) {
                                    html += '<li class="list-group-item">';
                                    html += '<span class="badge">'+parseFloat(topics[i][j]['probability']).toPrecision(3)+'</span>';
                                    html += topics[i][j]['word'];
                                    html += '</li>';
                                }
                                html += '</ul>';
                                html += '</li>';
                            }
                            html += '</ul>';

                            // Add HTML to taxonomy elm
                            $( '#taxonomy' ).append(html);
                        },
                        error: function(){
                            alert("Entrei no Fail");
                        },
                        load: function(){
                            $( '#load-tax' ).show();
                        }
                    });

                    // Load maps
                    //initialize();


                    // Load maps for elements with location
                    $.ajax({
                        type: "GET",
                        url: "${request.route_url('crime_locations')}",
                        data: "",
                        dataType: "json",
                        success: function(result){
                            $( '#load-maps' ).hide();
                            $( '#status-table').show();
                            //var topics = data;
                            // Asynchronously load the maps elements.
                            var markers = [];
                            var evaluation = 0;
                            var html = "";

                            // Get results
                            var status = result['status'];
                            var crimes = result['crimes'];

                            for (var i = 0; i < status['result_count']; i++ ) {
                                // Get Category for this token
                                var category = findTokenCategory(status['results'][i]['search_term'], crimes);

                                // Load default data
                                var title = "Status id " + status['results'][i]['_metadata']['id_doc'];
                                var embed_url = "/embed/twitter/" + status['results'][i]['_metadata']['id_doc'];
                                var status_id = status['results'][i]['_metadata']['id_doc'];

                                // Consider only positive status
                                if (( 'location' in status['results'][i]) && ('positives' in status['results'][i])) {
                                    if ('negatives' in status['results'][i]) {
                                        if (status['results'][i]['positives'] > status['results']['negatives']) {
                                            markers.push({
                                                'latitude': status['results'][i]['location']['latitude'],
                                                'longitude': status['results'][i]['location']['longitude'],
                                                'title': title,
                                                'embed_url': embed_url,
                                                'status_id': status_id,
                                                'category': category
                                            });
                                            evaluation = parseInt(status['results'][i]['positives']) - parseInt(status['results']['negatives'])
                                        }
                                    } else {
                                        markers.push({
                                            'latitude': status['results'][i]['location']['latitude'],
                                            'longitude': status['results'][i]['location']['longitude'],
                                            'title': title,
                                            'embed_url': embed_url,
                                            'status_id': status_id,
                                            'category': category
                                        });
                                        evaluation = parseInt(status['results'][i]['positives']);
                                    }
                                }

                                // Add status visualization
                                if (i < 10) {
                                    // Only 10 first status with more positives
                                    html += "<tr>";
                                    html += "<td>" + status['results'][i]['inclusion_datetime'] + "</td>";
                                    html += "<td>" + evaluation.toString() + "</td>";
                                    html += "<td>" + status['results'][i]['text'] + "</td>";
                                    html += "<td>" + status['results'][i]['origin'] + "</td>";
                                    html += "</tr>";
                                    $( '#status' ).append(html);
                                }
                            }

                            // Load Map with all markers
                            initialize(markers);

                        },
                        error: function(){
                            alert("Entrei no Fail");
                        },
                        load: function(){
                            $( '#load-maps' ).show();
                        }
                    });

                });
            });
        </script>
    </metal:content>

</metal:main>